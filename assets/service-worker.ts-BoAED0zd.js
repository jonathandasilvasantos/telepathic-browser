var Ne=Object.defineProperty;var Ue=(e,t,o)=>t in e?Ne(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var be=(e,t,o)=>Ue(e,typeof t!="symbol"?t+"":t,o);import{d as r}from"./debug-DFVv5X1n.js";import{a as he,b as ie,f as Te,P as re,D as Ce,d as xe,B as Ee}from"./storage-CWpUKz6p.js";const Pe=12e4,oe=10,Oe=1e3,De=3e4,Le=e=>new Promise(t=>setTimeout(t,e));function $e(e){if(e instanceof Error){const t=e.message.toLowerCase();return t.includes("network")||t.includes("timeout")||t.includes("aborted")||t.includes("fetch failed")||t.includes("429")||t.includes("rate limit")||t.includes("500")||t.includes("502")||t.includes("503")||t.includes("504")}return!1}class Se{constructor(t){be(this,"config");this.config=t}setApiKey(t){this.config.apiKey=t}setModel(t){this.config.model=t}setBaseUrl(t){this.config.baseUrl=t}async*chat(t,o={}){var T,S,U,E,P,k,K;const{tools:n,stream:a=!0}=o,s={model:this.config.model,messages:t,tools:n!=null&&n.length?n:void 0,tool_choice:n!=null&&n.length?"auto":void 0,stream:a},f=`${this.config.baseUrl}/chat/completions`;r.api("Model:",this.config.model),r.api("Tool choice:",s.tool_choice),r.api("Tools:",n==null?void 0:n.map(l=>l.function.name)),r.api("Messages count:",t.length),r.api("Last message:",t[t.length-1]);const h=await fetch(f,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(s)});if(!h.ok){const l=await h.text();throw new Error(`API Error (${h.status}): ${l}`)}if(!a){const l=await h.json(),$=(T=l.choices)==null?void 0:T[0];$&&(r.api("Tool calls:",(S=$.message)==null?void 0:S.tool_calls),r.api("Finish reason:",$.finish_reason)),yield l;return}const g=(U=h.body)==null?void 0:U.getReader();if(!g)throw new Error("No response body");const i=new TextDecoder;let y="";try{for(;;){const{done:l,value:$}=await g.read();if(l)break;y+=i.decode($,{stream:!0});const O=y.split(`
`);y=O.pop()||"";for(const I of O){const m=I.trim();if(!(!m||m==="data: [DONE]")&&m.startsWith("data: "))try{const v=JSON.parse(m.slice(6)),C=(P=(E=v.choices)==null?void 0:E[0])==null?void 0:P.delta;C!=null&&C.tool_calls&&r.api("Stream tool calls:",C.tool_calls),(K=(k=v.choices)==null?void 0:k[0])!=null&&K.finish_reason&&r.api("Stream finish:",v.choices[0].finish_reason),yield v}catch{}}}}finally{g.releaseLock()}}async chatNonStreaming(t,o={}){return(await this.chat(t,{...o,stream:!1}).next()).value}async chatWithRetry(t,o={},n){var s,f;let a=null;for(let h=1;h<=oe;h++)try{r.api(`API attempt ${h}/${oe}`);const g=new AbortController,i=setTimeout(()=>{g.abort(),r.warn(`Request timeout after ${Pe}ms`)},Pe),{tools:y,stream:T=!1}=o,S={model:this.config.model,messages:t,tools:y!=null&&y.length?y:void 0,tool_choice:y!=null&&y.length?"auto":void 0,stream:T},U=`${this.config.baseUrl}/chat/completions`,E=await fetch(U,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(S),signal:g.signal});if(clearTimeout(i),!E.ok){const K=await E.text(),l=new Error(`API Error (${E.status}): ${K}`);throw E.status>=400&&E.status<500&&E.status!==429,l}const P=await E.json();r.group("Telepathic API Response");const k=(s=P.choices)==null?void 0:s[0];return k&&(r.api("Tool calls:",(f=k.message)==null?void 0:f.tool_calls),r.api("Finish reason:",k.finish_reason)),r.groupEnd(),P}catch(g){if(a=g instanceof Error?g:new Error(String(g)),r.error(`Attempt ${h} failed:`,a.message),h<oe&&$e(g)){const i=Math.min(Oe*Math.pow(2,h-1),De);n==null||n(h,oe,a.message,i),await Le(i)}else if(!$e(g))break}throw a||new Error(`Request failed after ${oe} retries`)}}let ne=null;function Fe(e){return!ne&&e&&(ne=new Se(e)),ne||(ne=new Se({apiKey:"",model:"glm-4.7",baseUrl:""})),ne}function ge(e,t){return chrome.tabs.sendMessage(e,t)}async function Ke(e,t){const{ref_id:o,click_type:n="left"}=t;try{const a=await ge(e,{type:"EXECUTE_ACTION",payload:{type:"click",refId:o,clickType:n}});return a&&typeof a=="object"&&"error"in a?`Failed to click element ${o}: ${a.error}`:`Successfully clicked element ${o}`}catch(a){return`Failed to click element ${o}: ${a}`}}async function Be(e,t){const{ref_id:o,text:n}=t;try{const a=await ge(e,{type:"EXECUTE_ACTION",payload:{type:"type_text",refId:o,text:n}});return a&&typeof a=="object"&&"error"in a?`Failed to type into element ${o}: ${a.error}`:`Successfully typed "${n}" into element ${o}`}catch(a){return`Failed to type into element ${o}: ${a}`}}async function qe(e,t){const{url:o}=t;try{let n=o;return!o.startsWith("http://")&&!o.startsWith("https://")&&(n=`https://${o}`),await chrome.tabs.update(e,{url:n}),`Navigating to ${n}`}catch(n){return`Failed to navigate to ${o}: ${n}`}}async function Ye(e,t){const{direction:o,amount:n=500}=t;try{const a=await ge(e,{type:"EXECUTE_ACTION",payload:{type:"scroll",direction:o,amount:n}});return a&&typeof a=="object"&&"error"in a?`Failed to scroll: ${a.error}`:`Scrolled ${o} by ${n}px`}catch(a){return`Failed to scroll: ${a}`}}async function We(e,t=.5){const n=await(await fetch(e)).blob(),a=await createImageBitmap(n),s=new OffscreenCanvas(Math.floor(a.width*t),Math.floor(a.height*t)),f=s.getContext("2d");if(!f)throw new Error("Failed to get canvas context");f.drawImage(a,0,0,s.width,s.height),a.close();const h=await s.convertToBlob({type:"image/jpeg",quality:.7});return{dataUrl:await new Promise((i,y)=>{const T=new FileReader;T.onloadend=()=>i(T.result),T.onerror=y,T.readAsDataURL(h)}),width:s.width,height:s.height}}async function He(e={}){var t;try{const o=await chrome.tabs.captureVisibleTab({format:"png",quality:90}),n=await We(o,.5);let a=1,s=0,f=0;try{const[g]=await chrome.tabs.query({active:!0,currentWindow:!0});if(g!=null&&g.id){const i=await chrome.scripting.executeScript({target:{tabId:g.id},func:()=>({dpr:window.devicePixelRatio,width:window.innerWidth,height:window.innerHeight})});(t=i==null?void 0:i[0])!=null&&t.result&&(a=i[0].result.dpr||1,s=i[0].result.width||0,f=i[0].result.height||0)}}catch{}return`${`[Screenshot: ${s}x${f} viewport, ${a}x DPI, resized to ${n.width}x${n.height}]`}
${n.dataUrl}`}catch(o){throw new Error(`Failed to capture screenshot: ${o}`)}}async function Xe(e,t={}){const{filter:o="interactive"}=t;try{const n=await ge(e,{type:"GET_ACCESSIBILITY_TREE",payload:{filter:o}});return n&&typeof n=="object"&&"error"in n?`Failed to read page: ${n.error}`:typeof n=="string"?n:"Failed to read page: unexpected response"}catch(n){return`Failed to read page: ${n}`}}async function pe(e,t,o){switch(e){case"click":return Ke(o,t);case"type_text":return Be(o,t);case"navigate":return qe(o,t);case"scroll":return Ye(o,t);case"screenshot":return He(t);case"read_page":return Xe(o,t);default:return`Unknown tool: ${e}`}}let le=null,ue=null,_e;function je(){return!le||!ue?null:{conversation:le,tabId:ue,provider:_e}}function de(e,t,o){le=e,ue=t,_e=o}function ze(){le=null,ue=null,_e=void 0}const Ie=100,Ge="tb_debug_logs";let ae=[];async function me(e,t,o,n){const a={timestamp:new Date().toISOString(),level:e,source:t,message:o,data:n?JSON.parse(JSON.stringify(n)):void 0};ae.push(a),ae.length>Ie&&(ae=ae.slice(-Ie)),Je()}let we=null;function Je(){we&&clearTimeout(we),we=setTimeout(async()=>{try{await chrome.storage.local.set({[Ge]:ae})}catch{}},500)}function Ve(e){return{info:(t,o)=>me("info",e,t,o),warn:(t,o)=>me("warn",e,t,o),error:(t,o)=>me("error",e,t,o)}}const ce=Ve("ServiceWorker"),x=Fe();function Me(e,t){var f,h;const o=t?((f=re[t])==null?void 0:f.name)||t:"the API",n=t?(h=re[t])==null?void 0:h.apiKeyUrl:void 0,a=e.match(/API Error \((\d+)\)/),s=a?parseInt(a[1]):0;if(s===401||e.includes("token expired")||e.includes("incorrect")||e.includes("Unauthorized")||e.includes("invalid.*key")){let g=`Authentication failed for ${o}. Your API key is invalid or expired.`;return n?g+=` Please check your key at ${n} and update it in Settings.`:g+=" Please update your API key in Settings.",g}return s===403||e.includes("Forbidden")||e.includes("permission")?`Access denied by ${o}. Your API key may not have permission to use this model. Check your plan or permissions.`:s===404?`Model not found on ${o}. The selected model may not be available for your account. Try a different model.`:s===429||e.includes("rate limit")||e.includes("quota")?`Rate limit reached on ${o}. Please wait a moment and try again, or check your usage quota.`:s===402||e.includes("insufficient")||e.includes("billing")?`Billing issue with ${o}. Your account may have insufficient credits or an expired plan.`:s>=500?`${o} server error (${s}). The service may be temporarily unavailable. Please try again later.`:e.includes("fetch failed")||e.includes("network")||e.includes("Failed to fetch")?`Cannot reach ${o}. Please check your internet connection and try again.`:e.includes("timeout")||e.includes("aborted")?`Request to ${o} timed out. The server may be overloaded. Please try again.`:`Error from ${o}: ${e.replace(/^Error:\s*/,"")}`}const ve=30,Re=1e3;let H=!1;const z=new Set;function u(e,t){if(!z.has(e))return!1;try{return e.postMessage(t),!0}catch{return z.delete(e),!1}}(async()=>{const e=await he(),t=await ie(e.provider);t&&x.setApiKey(t);const o=Te(e.provider,e);o&&x.setBaseUrl(o),e.defaultModel&&x.setModel(e.defaultModel)})();chrome.action.onClicked.addListener(e=>{e.id&&chrome.sidePanel.open({tabId:e.id})});chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0});async function se(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(e!=null&&e.id))throw new Error("No active tab found");return e.id}async function Ae(e,t=3e4){return new Promise(o=>{const n=Date.now(),a=async()=>{try{if((await chrome.tabs.get(e)).status==="complete"){setTimeout(o,800);return}if(Date.now()-n>t){o();return}setTimeout(a,200)}catch{o()}};a()})}async function ye(e){const t=await he(),o=Te(e,t),n=await ie(e);o&&x.setBaseUrl(o),n&&x.setApiKey(n)}chrome.runtime.onMessage.addListener((e,t,o)=>{if(e.type==="CHAT_REQUEST")return et(e.payload).then(o).catch(n=>o({error:n.message})),!0;if(e.type==="UPDATE_API_KEY")return x.setApiKey(e.payload.apiKey),o({success:!0}),!0;if(e.type==="UPDATE_MODEL")return x.setModel(e.payload.model),o({success:!0}),!0;if(e.type==="UPDATE_PROVIDER"){const{provider:n}=e.payload;return ye(n).then(()=>{o({success:!0})}),!0}if(e.type==="EXECUTE_TOOL")return tt(e.payload).then(o).catch(n=>o({error:n.message})),!0;if(e.type==="TAKE_SCREENSHOT")return ot().then(o).catch(n=>o({error:n.message})),!0;if(e.type==="STOP_AGENT")return H=!0,o({success:!0}),!0});chrome.runtime.onConnect.addListener(e=>{e.name==="chat-stream"&&(r.log("Port connected:",e.name),ce.info("Port connected",{name:e.name}),z.add(e),e.onDisconnect.addListener(()=>{var o;const t=((o=chrome.runtime.lastError)==null?void 0:o.message)||"unknown reason";ce.warn("Port disconnected",{reason:t}),z.delete(e)}),e.onMessage.addListener(async t=>{r.log("Port message received:",t.type),ce.info("Message received",{type:t.type});try{t.type==="STREAM_CHAT"&&await Qe(t.payload,e),t.type==="CONTINUE"&&await Ze(e)}catch(o){ce.error("Unhandled error",{error:String(o)}),u(e,{type:"error",error:String(o)})}}))});function fe(e,t){try{chrome.tabs.sendMessage(e,{type:t?"SHOW_STOP_BUTTON":"HIDE_STOP_BUTTON"}).catch(()=>{})}catch{}}function ke(e){let t=!1,o=0;const n=3,a=setInterval(async()=>{try{await chrome.tabs.sendMessage(e,{type:"HEARTBEAT_PING"}),o=0}catch{o++,o>=n&&(t=!0,clearInterval(a))}},5e3);return{isDead:()=>t,stop:()=>clearInterval(a)}}async function Qe(e,t){var G,J,V,Q,Z,ee,M,q;const{messages:o,model:n,provider:a,useTools:s=!0}=e;n&&x.setModel(n),a&&await ye(a);const f=await ie(a);if(!f){const A=a?((G=re[a])==null?void 0:G.name)||a:"the selected provider",p=a?(J=re[a])==null?void 0:J.apiKeyUrl:void 0;let b=`No API key configured for ${A}.`;p?b+=` Get one at ${p} and set it in Settings.`:b+=" Please set it in Settings.",u(t,{type:"error",error:b});return}x.setApiKey(f),r.log("API key loaded, length:",f.length);const h=()=>z.has(t),i=[{role:"system",content:Ce},...o];let y=s?Ee:void 0,T;try{T=await se()}catch{u(t,{type:"error",error:"No active tab found. Please open a tab first."});return}const S=await he(),U=S.maxIterations||ve,E=S.enableNudgeSystem,P=a||S.provider;if(y){const p=xe(P,S).find(b=>b.id===(n||S.defaultModel));p&&!p.supportsVision&&(y=y.filter(b=>b.function.name!=="screenshot"))}r.log("Starting agentic loop with",i.length,"messages","maxIterations:",U,"nudge:",E,"provider:",P);const k=ke(T);fe(T,!0),H=!1;const K=(A,p,b,w)=>{u(t,{type:"status",message:`API error, retrying... (${A}/${p}) - waiting ${Math.round(w/1e3)}s`})},l=[];let $="",O=0,I="",m=0,v=0,C="",L=0;const X=3,j=2,F=3,B=()=>{k.stop(),fe(T,!1)};try{for(let A=0;A<U;A++){if(!h()){r.warn("Port disconnected, stopping agentic loop"),B();return}if(H){r.log("Stop requested by user"),H=!1,u(t,{type:"done",content:"Agent stopped by user."}),B();return}if(k.isDead()){r.warn("Tab is dead, stopping agentic loop"),u(t,{type:"error",error:"The tab was closed or crashed. Agent stopped."}),B();return}if(r.log("Iteration",A+1),u(t,{type:"status",message:`Thinking... (step ${A+1})`}),E&&(O>=X||L>=F)){v++;const _=v>=2,N=L>=F?"repeated content":"empty iterations";r.log("Loop detector: nudge #"+v,_?"(hard)":"(soft)","reason:",N),i.push({role:"user",content:_?"You have been calling tools for too long without answering. STOP calling tools now and answer my original question with whatever information you have gathered so far. If you could not find the answer, say so.":"You seem to be repeating the same actions without making progress. Try a completely different approach, or if you have enough information, share what you have found so far. Then you may continue if needed."}),O=0,L=0}const p=await x.chatWithRetry(i,{tools:y},K);r.api("Raw response:",p);const b=(V=p.choices)==null?void 0:V[0];if(!b){r.warn("No choice in response"),u(t,{type:"error",error:"No response from API"}),B();return}const w=((Q=b.delta)==null?void 0:Q.content)||((Z=b.message)==null?void 0:Z.content)||"",te=((ee=b.delta)==null?void 0:ee.tool_calls)||((M=b.message)==null?void 0:M.tool_calls)||[];r.log("Content:",w),r.tool("Tool calls:",te),w&&(u(t,{type:"chunk",content:w}),w.length>50&&($=w));const c=[];if(Array.isArray(te)){for(const d of te)if((q=d.function)!=null&&q.name){const _={id:d.id||`call_${Date.now()}_${c.length}`,type:"function",function:{name:d.function.name,arguments:d.function.arguments||"{}"}};d.extra_content&&(_.extra_content=d.extra_content),c.push(_)}}const R={role:"assistant",content:w,tool_calls:c.length>0?c:void 0};if(i.push(R),E&&(!w&&c.length>0?O++:(O=0,w&&c.length>0&&(v=0)),w&&c.length>0)){const d=w.trim().slice(0,200);d===C?(L++,r.log("Loop detector: repeated content",L,"/",F)):(C=d,L=0)}if(c.length===0){r.log("No tool calls, finishing"),r.log("Executed actions count:",l.length);let d=w;!d&&$?(r.log("Empty final content, using last meaningful chunk as answer"),d=$):!d&&l.length>0&&(d="Task completed."),r.log("Sending done message, content length:",(d==null?void 0:d.length)||0);const _=u(t,{type:"done",content:d});r.log("Done message sent:",_),B();return}r.tool("Executing",c.length,"tool calls"),u(t,{type:"status",message:`Executing ${c.length} action(s)...`});for(const d of c){const{name:_,arguments:N}=d.function;r.tool("Executing:",_,"args:",N),u(t,{type:"tool_start",tool:_,params:N});let D={};try{D=JSON.parse(N)}catch(Y){r.warn("Failed to parse args:",Y),D={}}let W;try{W=await pe(_,D,T),r.tool("Tool result:",W.slice(0,200))}catch(Y){W=`Error: ${Y}`,r.error("Tool error:",Y)}if(E&&_==="read_page"){const Y=W.slice(0,500);Y===I?(m++,r.log("Loop detector: repeated read_page result",m,"/",j),m>=j&&(W+=`

[System: You have read the same page content multiple times. Try a different approach — navigate to a more specific URL, use a search, or answer with what you know so far.]`,m=0)):(I=Y,m=0)}if(i.push({role:"tool",tool_call_id:d.id,content:W}),u(t,{type:"tool_done",tool:_,result:W.slice(0,100)}),l.push({tool:_,result:W.slice(0,100)}),_==="navigate"){u(t,{type:"status",message:"Waiting for page to load..."}),await Ae(T);try{T=await se()}catch{}}await new Promise(Y=>setTimeout(Y,Re))}await new Promise(d=>setTimeout(d,300))}de(i,T,P),u(t,{type:"paused",message:`Reached ${U} actions. Click Continue for more.`}),B()}catch(A){const p=String(A);de(i,T,P),u(t,{type:"error",error:Me(p,P),canRetry:!0}),B()}}async function Ze(e){var B,G,J,V,Q,Z,ee;const t=je();if(!t){u(e,{type:"error",error:"No paused conversation to continue"});return}const o=t.conversation;let n=t.tabId;const a=t.provider;ze();const s=await he(),f=a||s.provider;await ye(f);const h=await ie(f);if(!h){u(e,{type:"error",error:`API key not configured for ${((B=re[f])==null?void 0:B.name)||f}.`});return}x.setApiKey(h);const g=Te(f,s);g&&x.setBaseUrl(g);const i=s.enableNudgeSystem;let y=Ee;const S=xe(f,s).find(M=>M.id===s.defaultModel);S&&!S.supportsVision&&(y=y.filter(M=>M.function.name!=="screenshot"));const U=()=>z.has(e),E=s.maxIterations||ve;r.log("Continuing agentic loop with",o.length,"messages","maxIterations:",E,"nudge:",i);const P=ke(n);fe(n,!0),H=!1;const k=(M,q,A,p)=>{u(e,{type:"status",message:`API error, retrying... (${M}/${q}) - waiting ${Math.round(p/1e3)}s`})},K=[];let l="",$=0,O="",I=0,m=0,v="",C=0;const L=3,X=2,j=3,F=()=>{P.stop(),fe(n,!1)};try{for(let M=0;M<E;M++){if(!U()){r.warn("Port disconnected, stopping continue loop"),F();return}if(H){r.log("Stop requested by user"),H=!1,u(e,{type:"done",content:"Agent stopped by user."}),F();return}if(P.isDead()){r.warn("Tab is dead, stopping continue loop"),u(e,{type:"error",error:"The tab was closed or crashed. Agent stopped."}),F();return}if(r.log("Continue iteration",M+1),u(e,{type:"status",message:`Thinking... (step ${M+1})`}),i&&($>=L||C>=j)){m++;const R=m>=2,d=C>=j?"repeated content":"empty iterations";r.log("Loop detector: nudge #"+m,R?"(hard)":"(soft)","reason:",d),o.push({role:"user",content:R?"You have been calling tools for too long without answering. STOP calling tools now and answer my original question with whatever information you have gathered so far. If you could not find the answer, say so.":"You seem to be repeating the same actions without making progress. Try a completely different approach, or if you have enough information, share what you have found so far. Then you may continue if needed."}),$=0,C=0}const q=await x.chatWithRetry(o,{tools:y},k);r.api("Raw response:",q);const A=(G=q.choices)==null?void 0:G[0];if(!A){r.warn("No choice in response"),u(e,{type:"error",error:"No response from API"}),F();return}const p=((J=A.delta)==null?void 0:J.content)||((V=A.message)==null?void 0:V.content)||"",b=((Q=A.delta)==null?void 0:Q.tool_calls)||((Z=A.message)==null?void 0:Z.tool_calls)||[];r.log("Content:",p),r.tool("Tool calls:",b),p&&(u(e,{type:"chunk",content:p}),p.length>50&&(l=p));const w=[];if(Array.isArray(b)){for(const c of b)if((ee=c.function)!=null&&ee.name){const R={id:c.id||`call_${Date.now()}_${w.length}`,type:"function",function:{name:c.function.name,arguments:c.function.arguments||"{}"}};c.extra_content&&(R.extra_content=c.extra_content),w.push(R)}}const te={role:"assistant",content:p,tool_calls:w.length>0?w:void 0};if(o.push(te),i&&(!p&&w.length>0?$++:($=0,p&&w.length>0&&(m=0)),p&&w.length>0)){const c=p.trim().slice(0,200);c===v?(C++,r.log("Loop detector: repeated content",C,"/",j)):(v=c,C=0)}if(w.length===0){r.log("No tool calls, finishing");let c=p;!c&&l?(r.log("Empty final content, using last meaningful chunk as answer"),c=l):!c&&K.length>0&&(c="Task completed."),u(e,{type:"done",content:c}),F();return}r.tool("Executing",w.length,"tool calls"),u(e,{type:"status",message:`Executing ${w.length} action(s)...`});for(const c of w){const{name:R,arguments:d}=c.function;r.tool("Executing:",R,"args:",d),u(e,{type:"tool_start",tool:R,params:d});let _={};try{_=JSON.parse(d)}catch(D){r.warn("Failed to parse args:",D),_={}}let N;try{N=await pe(R,_,n),r.tool("Tool result:",N.slice(0,200))}catch(D){N=`Error: ${D}`,r.error("Tool error:",D)}if(i&&R==="read_page"){const D=N.slice(0,500);D===O?(I++,r.log("Loop detector: repeated read_page result",I,"/",X),I>=X&&(N+=`

[System: You have read the same page content multiple times. Try a different approach — navigate to a more specific URL, use a search, or answer with what you know so far.]`,I=0)):(O=D,I=0)}if(K.push({tool:R,result:N.slice(0,100)}),o.push({role:"tool",tool_call_id:c.id,content:N}),u(e,{type:"tool_done",tool:R,result:N.slice(0,100)}),R==="navigate"){u(e,{type:"status",message:"Waiting for page to load..."}),await Ae(n);try{n=await se()}catch{}}await new Promise(D=>setTimeout(D,Re))}await new Promise(c=>setTimeout(c,300))}de(o,n,f),u(e,{type:"paused",message:`Reached ${E} more actions. Click Continue for more.`}),F()}catch(M){const q=String(M);de(o,n,f),u(e,{type:"error",error:Me(q,f),canRetry:!0}),F()}}async function et(e){var y,T,S,U,E,P;const{messages:t,model:o,provider:n,useTools:a=!0}=e;o&&x.setModel(o),n&&await ye(n);const s=await ie(n);if(!s)throw new Error("API key not configured.");x.setApiKey(s);const h=[{role:"system",content:Ce},...t],g=a?Ee:void 0;let i;try{i=await se()}catch{}for(let k=0;k<ve;k++){const l=(y=(await x.chatWithRetry(h,{tools:g})).choices)==null?void 0:y[0],$=((T=l==null?void 0:l.delta)==null?void 0:T.content)||((S=l==null?void 0:l.message)==null?void 0:S.content)||"",O=((U=l==null?void 0:l.delta)==null?void 0:U.tool_calls)||((E=l==null?void 0:l.message)==null?void 0:E.tool_calls)||[],I=[];if(Array.isArray(O)){for(const m of O)if((P=m.function)!=null&&P.name){const v={id:m.id||`call_${Date.now()}`,type:"function",function:{name:m.function.name,arguments:m.function.arguments||"{}"}};m.extra_content&&(v.extra_content=m.extra_content),I.push(v)}}if(h.push({role:"assistant",content:$,tool_calls:I.length>0?I:void 0}),I.length===0||!i)return{role:"assistant",content:$};for(const m of I){const{name:v,arguments:C}=m.function;let L={};try{L=JSON.parse(C)}catch{L={}}const X=await pe(v,L,i);h.push({role:"tool",tool_call_id:m.id,content:X}),v==="navigate"&&await Ae(i)}}return{role:"assistant",content:"Task completed."}}async function tt(e){const t=await se();return{result:await pe(e.tool,e.params,t)}}async function ot(){return{dataUrl:await chrome.tabs.captureVisibleTab({format:"png",quality:90})}}
