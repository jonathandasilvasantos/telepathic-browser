import{r as h,j as e,c as A,R as B}from"./client-CtI-t4g5.js";import{d as P}from"./debug-DFVv5X1n.js";import{P as $,g as R,s as D,a as V,b as _}from"./storage-CWpUKz6p.js";function O(s){let i=s.replace(/```[\s\S]*?```/g,"");return i=i.replace(/`([^`]*)`/g,"$1"),i=i.replace(/\n{3,}/g,`

`),i.trim()}function K(s){return new Promise(i=>{try{chrome.i18n.detectLanguage(s,o=>{var t;(t=o==null?void 0:o.languages)!=null&&t.length&&o.languages[0].percentage>50?i(o.languages[0].language):i("en")})}catch{i("en")}})}function W(s){const i=speechSynthesis.getVoices(),o=s.toLowerCase(),t=i.filter(n=>{const g=n.lang.toLowerCase();return g===o||g.startsWith(o)||o.startsWith(g)});if(t.length===0)return;const r=t.find(n=>n.name.startsWith("Google"));if(r)return r;const l=t.find(n=>n.default);return l||t[0]}function F(){const[s,i]=h.useState(null),o=h.useRef(null),t=h.useCallback(()=>{speechSynthesis.cancel(),o.current=null,i(null)},[]),r=h.useCallback(n=>{if(s===n){t();return}speechSynthesis.cancel();const g=O(n);if(!g)return;const j=new SpeechSynthesisUtterance(g);o.current=j,i(n),j.onend=()=>{i(null),o.current=null},j.onerror=()=>{i(null),o.current=null},K(g).then(p=>{j.lang=p;const b=W(p);b&&(j.voice=b),P.ui("TTS speaking",{lang:p,voice:b==null?void 0:b.name,textLength:g.length}),speechSynthesis.speak(j)})},[s,t]),l=h.useCallback(n=>s===n?"playing":"idle",[s]);return h.useEffect(()=>()=>{speechSynthesis.cancel()},[]),{speak:r,stop:t,getState:l}}function H({messages:s,isLoading:i,activeTools:o}){var l;const t=h.useRef(null),r=F();return h.useEffect(()=>{var n;(n=t.current)==null||n.scrollIntoView({behavior:"smooth"})},[s,o]),s.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("div",{className:"empty-state-icon",children:e.jsx(I,{size:64})}),e.jsx("h2",{className:"empty-state-title",children:"Telepathic Browser"}),e.jsx("p",{className:"empty-state-text",children:"Ask me to help you browse the web, fill out forms, or analyze page content."})]}):e.jsxs("div",{className:"messages",children:[s.map((n,g)=>e.jsx(z,{message:n,tts:r},g)),o.length>0&&e.jsx("div",{className:"active-tools",children:o.map((n,g)=>e.jsx(te,{tool:n},g))}),i&&((l=s[s.length-1])==null?void 0:l.content)===""&&o.length===0&&e.jsx("div",{className:"message message-assistant",children:e.jsxs("div",{className:"message-content loading",children:[e.jsx("span",{className:"loading-dot"}),e.jsx("span",{className:"loading-dot"}),e.jsx("span",{className:"loading-dot"})]})}),e.jsx("div",{ref:t})]})}function z({message:s,tts:i}){var l,n;if(s.role==="tool")return null;const t=typeof s.content=="string"?s.content:"";if(!t&&!((l=s.tool_calls)!=null&&l.length))return null;const r=s.role==="assistant";return e.jsx("div",{className:`message message-${s.role}`,children:e.jsxs("div",{className:"message-content",children:[t&&e.jsx(G,{content:t}),(n=s.tool_calls)==null?void 0:n.map((g,j)=>e.jsx(J,{toolCall:g},j)),r&&t&&e.jsxs("div",{className:"message-actions",children:[e.jsx(X,{text:t,tts:i}),e.jsx(Y,{text:t})]})]})})}function G({content:s}){const i=s.split(/```(\w*)\n?([\s\S]*?)```/g);return e.jsx(e.Fragment,{children:i.map((o,t)=>t%3===1?null:t%3===2?e.jsx("pre",{children:e.jsx("code",{children:o})},t):e.jsx(h.Fragment,{children:o.split(`
`).map((r,l)=>e.jsxs(h.Fragment,{children:[l>0&&e.jsx("br",{}),U(r)]},l))},t))})}function U(s){const i=[],o=/`([^`]+)`/g;let t=0,r;for(;(r=o.exec(s))!==null;)r.index>t&&i.push(s.slice(t,r.index)),i.push(e.jsx("code",{children:r[1]},r.index)),t=r.index+r[0].length;return t<s.length&&i.push(s.slice(t)),i}function J({toolCall:s}){const{name:i,arguments:o}=s.function;let t={};try{t=JSON.parse(o)}catch{t={raw:o}}return e.jsxs("div",{className:"tool-call",children:[e.jsxs("div",{className:"tool-call-header",children:[e.jsx(I,{}),e.jsx("span",{children:i})]}),e.jsx("div",{className:"tool-call-params",children:Object.entries(t).map(([r,l])=>e.jsxs("div",{children:[r,": ",JSON.stringify(l)]},r))})]})}function Y({text:s}){const[i,o]=h.useState(!1),t=async()=>{try{await navigator.clipboard.writeText(s),o(!0),setTimeout(()=>o(!1),2e3)}catch{const r=document.createElement("textarea");r.value=s,r.style.position="fixed",r.style.opacity="0",document.body.appendChild(r),r.select(),document.execCommand("copy"),document.body.removeChild(r),o(!0),setTimeout(()=>o(!1),2e3)}};return e.jsxs("button",{className:`copy-btn ${i?"copy-btn-copied":""}`,onClick:t,title:i?"Copied!":"Copy to clipboard","aria-label":i?"Copied!":"Copy to clipboard",children:[i?e.jsx(Q,{}):e.jsx(q,{}),e.jsx("span",{children:i?"Copied":"Copy"})]})}function q(){return e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"9",y:"9",width:"13",height:"13",rx:"2",ry:"2"}),e.jsx("path",{d:"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"})]})}function Q(){return e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"20 6 9 17 4 12"})})}function X({text:s,tts:i}){const t=i.getState(s)==="playing",r=()=>{t?i.stop():i.speak(s)};return e.jsxs("button",{className:`listen-btn ${t?"listen-btn-playing":""}`,onClick:r,title:t?"Stop listening":"Listen","aria-label":t?"Stop listening":"Listen",children:[t?e.jsx(ee,{}):e.jsx(Z,{}),e.jsx("span",{children:t?"Stop":"Listen"})]})}function Z(){return e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",stroke:"none",children:e.jsx("path",{d:"M3 22v-20l18 10-18 10z"})})}function ee(){return e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",stroke:"none",children:e.jsx("rect",{x:"4",y:"4",width:"16",height:"16",rx:"2"})})}function I({size:s=18}){return e.jsx("img",{src:"/icons/icon-48.png",width:s,height:s,alt:"Telepathic Browser",style:{marginRight:"4px",borderRadius:s>32?"8px":"4px"}})}function te({tool:s}){return e.jsx("div",{className:"tool-call",style:{opacity:s.status==="done"?.7:1},children:e.jsxs("div",{className:"tool-call-header",children:[s.status==="running"?e.jsx(I,{}):e.jsx("span",{style:{marginRight:"4px"},children:"✓"}),e.jsx("span",{children:s.name})]})})}function ne({onSend:s,isLoading:i,disabled:o}){const[t,r]=h.useState(""),l=h.useRef(null),n=h.useCallback(()=>{const p=l.current;p&&(p.style.height="auto",p.style.height=`${Math.min(p.scrollHeight,200)}px`)},[]);h.useEffect(()=>{n()},[t,n]);const g=h.useCallback(()=>{const p=t.trim();p&&!i&&!o&&(s(p),r(""))},[t,i,o,s]),j=h.useCallback(p=>{p.key==="Enter"&&!p.shiftKey&&(p.preventDefault(),g())},[g]);return e.jsx("div",{className:"input-area",children:e.jsxs("div",{className:"input-container",children:[e.jsx("div",{className:"input-wrapper",children:e.jsx("textarea",{ref:l,className:"input-textarea",value:t,onChange:p=>r(p.target.value),onKeyDown:j,placeholder:"Ask Telepathic Browser to help...",disabled:o,rows:1})}),e.jsx("button",{className:"send-btn",onClick:g,disabled:!t.trim()||i||o,title:"Send message",children:e.jsx(se,{})})]})})}function se(){return e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13"})})}function re({value:s,onChange:i,customModelId:o,configuredProviders:t}){return e.jsx("select",{className:"model-selector",value:s,onChange:r=>{const[l,...n]=r.target.value.split(":"),g=n.join(":");i(l,g)},children:Object.entries($).map(([r,l])=>{if(t&&!t.has(r))return null;if(r==="custom"){const n=o||"(not configured)";return e.jsx("optgroup",{label:l.name,children:e.jsx("option",{value:`custom:${o||""}`,children:n})},r)}return e.jsx("optgroup",{label:l.name,children:l.models.map(n=>e.jsxs("option",{value:`${r}:${n.id}`,children:[n.name,n.supportsVision?" (Vision)":""]},`${r}:${n.id}`))},r)})})}function oe({model:s,provider:i}){const[o,t]=h.useState({messages:[],isLoading:!1,error:null,status:null,conversationId:R(),activeTools:[],canContinue:!1,rateLimitError:!1}),r=h.useRef(null),l=h.useRef(""),n=h.useRef([]),g=h.useCallback(async x=>{if(!x.trim())return;const C={role:"user",content:x},f=[...n.current,C];n.current=f,t(d=>({...d,messages:f,isLoading:!0,error:null,status:null}));const y=chrome.runtime.connect({name:"chat-stream"});r.current=y,l.current="";const k=[...f,{role:"assistant",content:""}];n.current=k,t(d=>({...d,messages:k})),y.onDisconnect.addListener(()=>{const d=chrome.runtime.lastError;d&&P.warn("Port disconnected:",d.message),t(c=>c.isLoading?{...c,isLoading:!1,status:null}:c)}),y.onMessage.addListener(d=>{var c,m,v,M,N,w;if(d.type==="chunk"&&(l.current+=d.content,t(a=>{const u=[...a.messages],L=u[u.length-1];return(L==null?void 0:L.role)==="assistant"&&(L.content=l.current),{...a,messages:u}})),d.type==="status"&&t(a=>({...a,status:d.message})),d.type==="tool_start"&&t(a=>({...a,activeTools:[...a.activeTools,{name:d.tool,status:"running"}],status:`Executing: ${d.tool}`})),d.type==="tool_done"&&t(a=>({...a,activeTools:a.activeTools.map(u=>u.name===d.tool?{...u,status:"done"}:u),status:null})),d.type==="done"){const a=[...n.current],u=d.content||l.current;((c=a[a.length-1])==null?void 0:c.role)==="assistant"&&(a[a.length-1].content=u),n.current=a,t(T=>({...T,messages:a,isLoading:!1,status:null,activeTools:[],canContinue:!1})),y.disconnect();const L={id:o.conversationId,title:((v=(m=n.current[0])==null?void 0:m.content)==null?void 0:v.toString().slice(0,50))||"New conversation",messages:a,createdAt:Date.now(),updatedAt:Date.now()};D(L)}if(d.type==="paused"){const a=[...n.current],u=d.content||l.current;((M=a[a.length-1])==null?void 0:M.role)==="assistant"&&(a[a.length-1].content=u),n.current=a,t(L=>({...L,messages:a,isLoading:!1,status:d.message,activeTools:[],canContinue:!0}))}if(d.type==="error")if(d.canRetry){const a=[...n.current];((N=a[a.length-1])==null?void 0:N.role)==="assistant"&&(a[a.length-1].content=l.current),n.current=a,t(u=>({...u,messages:a,isLoading:!1,error:d.error,status:null,activeTools:[],canContinue:!0,rateLimitError:!1}))}else t(a=>({...a,isLoading:!1,error:d.error,status:null,activeTools:[],canContinue:!1,rateLimitError:!1,messages:a.messages.slice(0,-1)})),n.current=n.current.slice(0,-1),y.disconnect();if(d.type==="rate_limit"){const a=[...n.current];((w=a[a.length-1])==null?void 0:w.role)==="assistant"&&(a[a.length-1].content=l.current),n.current=a,t(u=>({...u,messages:a,isLoading:!1,error:d.error,status:null,activeTools:[],canContinue:!0,rateLimitError:!0}))}}),y.postMessage({type:"STREAM_CHAT",payload:{messages:f,model:s,provider:i,useTools:!0}})},[s,i,o.conversationId]),j=h.useCallback(()=>{r.current&&(r.current.disconnect(),r.current=null),n.current=[],t({messages:[],isLoading:!1,error:null,status:null,conversationId:R(),activeTools:[],canContinue:!1,rateLimitError:!1})},[]),p=h.useCallback(x=>{r.current&&(r.current.disconnect(),r.current=null),n.current=x.messages,t({messages:x.messages,isLoading:!1,error:null,status:null,conversationId:x.id,activeTools:[],canContinue:!1,rateLimitError:!1})},[]),b=h.useCallback(()=>{r.current&&(r.current.disconnect(),r.current=null),t(x=>({...x,isLoading:!1,status:null,canContinue:!1}))},[]),S=h.useCallback(()=>{var x;if(!r.current||!o.canContinue){const C=chrome.runtime.connect({name:"chat-stream"});r.current=C,C.onDisconnect.addListener(()=>{t(f=>({...f,isLoading:!1,status:null,canContinue:!1}))}),C.onMessage.addListener(f=>{var y,k,d;if(f.type==="chunk"&&(l.current+=f.content,t(c=>{const m=[...c.messages],v=m[m.length-1];return(v==null?void 0:v.role)==="assistant"&&(v.content=l.current),{...c,messages:m}})),f.type==="status"&&t(c=>({...c,status:f.message})),f.type==="tool_start"&&t(c=>({...c,activeTools:[...c.activeTools,{name:f.tool,status:"running"}],status:`Executing: ${f.tool}`})),f.type==="tool_done"&&t(c=>({...c,activeTools:c.activeTools.map(m=>m.name===f.tool?{...m,status:"done"}:m),status:null})),f.type==="done"){const c=[...n.current],m=f.content||l.current;((y=c[c.length-1])==null?void 0:y.role)==="assistant"&&(c[c.length-1].content=m),n.current=c,t(v=>({...v,messages:c,isLoading:!1,status:null,activeTools:[],canContinue:!1})),C.disconnect()}if(f.type==="paused"){const c=[...n.current],m=f.content||l.current;((k=c[c.length-1])==null?void 0:k.role)==="assistant"&&(c[c.length-1].content=m),n.current=c,t(v=>({...v,messages:c,isLoading:!1,status:f.message,activeTools:[],canContinue:!0}))}if(f.type==="error"&&(t(c=>({...c,isLoading:!1,error:f.error,status:null,activeTools:[],canContinue:!1,rateLimitError:!1})),C.disconnect()),f.type==="rate_limit"){const c=[...n.current];((d=c[c.length-1])==null?void 0:d.role)==="assistant"&&(c[c.length-1].content=l.current),n.current=c,t(m=>({...m,messages:c,isLoading:!1,error:f.error,status:null,activeTools:[],canContinue:!0,rateLimitError:!0}))}})}t(C=>({...C,isLoading:!0,status:"Continuing...",canContinue:!1,rateLimitError:!1,error:null})),(x=r.current)==null||x.postMessage({type:"CONTINUE"})},[o.canContinue]);return{messages:o.messages,isLoading:o.isLoading,error:o.error,status:o.status,activeTools:o.activeTools,canContinue:o.canContinue,rateLimitError:o.rateLimitError,sendMessage:g,clearMessages:j,loadConversation:p,stopGeneration:b,continueGeneration:S}}function ae(){const[s,i]=h.useState("zhipu"),[o,t]=h.useState("glm-4.7"),[r,l]=h.useState(""),[n,g]=h.useState(new Set),[j,p]=h.useState(!1),{messages:b,isLoading:S,error:x,status:C,activeTools:f,canContinue:y,rateLimitError:k,sendMessage:d,clearMessages:c,continueGeneration:m}=oe({model:o,provider:s}),v=j?n.has(s):null;h.useEffect(()=>{(async()=>{const a=await V();a.provider&&i(a.provider),a.defaultModel&&t(a.defaultModel),a.customModelId&&l(a.customModelId);const u=new Set;for(const[T,E]of Object.entries(a.apiKeys))E&&u.add(T);await _()&&u.size===0&&u.add(a.provider||"zhipu"),g(u),p(!0)})();const w=a=>{if(a.tb_settings){const u=a.tb_settings.newValue;if(u!=null&&u.provider&&i(u.provider),(u==null?void 0:u.customModelId)!==void 0&&l(u.customModelId),u!=null&&u.apiKeys){const L=new Set;for(const[T,E]of Object.entries(u.apiKeys))E&&L.add(T);g(L)}}};return chrome.storage.onChanged.addListener(w),()=>chrome.storage.onChanged.removeListener(w)},[]);const M=(N,w)=>{i(N),t(w),chrome.runtime.sendMessage({type:"UPDATE_PROVIDER",payload:{provider:N}}),chrome.runtime.sendMessage({type:"UPDATE_MODEL",payload:{model:w}})};return e.jsxs("div",{className:"app",children:[e.jsxs("header",{className:"header",children:[e.jsxs("div",{className:"header-title",children:[e.jsx(le,{}),e.jsx("span",{children:"Telepathic Browser"})]}),e.jsxs("div",{className:"header-actions",children:[e.jsx(re,{value:`${s}:${o}`,onChange:M,customModelId:r,configuredProviders:n.size>0?n:void 0}),e.jsx("button",{className:"icon-btn",onClick:c,title:"New conversation",children:e.jsx(ie,{})}),e.jsx("button",{className:"icon-btn",onClick:()=>chrome.runtime.openOptionsPage(),title:"Settings",children:e.jsx(ce,{})})]})]}),v===!1&&e.jsxs("div",{className:"api-key-warning",children:[e.jsx("span",{children:"⚠️"}),e.jsxs("span",{children:["API key not configured."," ",e.jsx("a",{href:"#",onClick:()=>chrome.runtime.openOptionsPage(),children:"Set it in Settings"})]})]}),x&&!k&&!y&&e.jsxs("div",{className:"api-key-warning",children:[e.jsx("span",{children:"❌"}),e.jsx("span",{children:x})]}),x&&!k&&y&&e.jsxs("div",{className:"rate-limit-warning",children:[e.jsx("span",{children:"⚠️"}),e.jsx("span",{children:"API error after all retries. You can try again."}),e.jsx("button",{className:"retry-btn",onClick:m,children:"Retry"})]}),k&&e.jsxs("div",{className:"rate-limit-warning",children:[e.jsx("span",{children:"⏳"}),e.jsx("span",{children:"Rate limit reached. Wait a moment then try again."}),e.jsx("button",{className:"retry-btn",onClick:m,children:"Retry"})]}),e.jsx(H,{messages:b,isLoading:S,activeTools:f}),C&&!y&&e.jsxs("div",{className:"status-bar",children:[e.jsx("span",{className:"status-indicator"}),e.jsx("span",{children:C})]}),y&&e.jsxs("div",{className:"continue-bar",children:[e.jsx("span",{children:C}),e.jsx("button",{className:"continue-btn",onClick:m,children:"Continue"})]}),e.jsx(ne,{onSend:d,isLoading:S,disabled:v===!1})]})}function ie(){return e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})}function ce(){return e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"12",r:"3"}),e.jsx("path",{d:"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"})]})}function le(){return e.jsx("img",{src:"/icons/icon-32.png",width:"20",height:"20",alt:"Telepathic Browser",style:{borderRadius:"4px"}})}function ue(){return e.jsx(ae,{})}A.createRoot(document.getElementById("root")).render(e.jsx(B.StrictMode,{children:e.jsx(ue,{})}));
